#!/bin/sh
# include common script
. "`dirname $0`/common"
# and run needed checks before
is_hash

test_ssml_audio() {
	TEST_NAME=$1
	EXPECTED=$2
	TEST_TEXT=$3

	echo "testing ${TEST_NAME}"
	RESULT=$(
		ESPEAK_DATA_PATH=`pwd` LD_LIBRARY_PATH=src:${LD_LIBRARY_PATH} \
		$VALGRIND src/espeak-ng --stdout -m "${TEST_TEXT}" | $sha1sum | awk '{ print $1 }' || exit 1
	)
	if [ "x$RESULT" != "x$EXPECTED" ] ; then
		echo "$RESULT != $EXPECTED"
		exit 1
	fi
}

test_ssml() {
	INPUT=$1

	if [ "$2" = "punct" ]
	then
	PARAMETERS="--punct -x"
	else
	PARAMETERS="-v en-US --ipa=2"
	fi

	echo "testing ${INPUT}"
	EXPECTED=$(cat $(dirname $INPUT)/$(basename ${INPUT%.*}).expected)
	RESULT=$(
		ESPEAK_DATA_PATH=`pwd` LD_LIBRARY_PATH=src:${LD_LIBRARY_PATH} \
		$VALGRIND src/espeak-ng -m -q $PARAMETERS -f ${INPUT} || exit 1
	)
	if [ "x$RESULT" != "x$EXPECTED" ] ; then
		echo "$RESULT != $EXPECTED"
		exit 1
	fi
}

for i in `dirname $0`/ssml/*.ssml ; do test_ssml $i; done
for i in `dirname $0`/ssml/*.ssml2 ; do test_ssml $i punct; done

test_ssml_audio "<prosody>" 88fccb35536158f25f4ae44a03fb005fef95c99b "<speak><prosody rate=\"x-slow\" pitch=\"low\"> Slow and low </prosody><prosody rate=\"x-fast\" pitch=\"x-high\"> Fast and high.</prosody></speak>"
# #410 is a bug in SSML. Sentence termination causes prosody stack to misfunction. 
# Hash 8d3bace is the buggy version and should fail:
test_ssml_audio "<prosody> bug #410" 8d3bace9548ae73c4770a73c88c6f65e848b45cf "<speak><prosody rate=\"x-slow\" pitch=\"low\"> Slow and low. </prosody><prosody rate=\"x-fast\" pitch=\"x-high\"> Fast and high.</prosody></speak>"
test_ssml_audio "<audio>" 5134c1db757b2d6b8d1f3f2416124462e401b4c6 "<speak>ha: <audio src=\"$PWD/phsource/h/ha.wav\"></audio></speak>"

test_ssml_audio "<break> at start" 949ad49d180108b30c1f0f16bef6ca2f3b6199cd "<speak><break time=\"1000ms\"/>test</speak>"

# Test SSML breaks inside prosody (#1512)
test_ssml_audio "<prosody  50%><break 1000ms>" bc47aac0142243b31dd1930e3462abe541c1d9ff "<speak><prosody rate=\"50%\">Break<break time=\"1000ms\"/>test</prosody></speak>"
test_ssml_audio "<prosody 100%><break 1000ms>" c7b3e92d90063761e9744b40b17bc9204fe7d25b "<speak><prosody rate=\"100%\">Break<break time=\"1000ms\"/>test</prosody></speak>"
test_ssml_audio "<prosody 200%><break 1000ms>" 64213dbaf593b139b0b21840ba938cf597f7ad35 "<speak><prosody rate=\"200%\">Break<break time=\"1000ms\"/>test</prosody></speak>"

# Three cases following: HEAD#6a16cb3, libsonic 0.2.0-12, and --without-libsonic
( test_ssml_audio "<prosody 260%><break 1000ms>" 4b4e30a2cfff1889972f013e514e81c1108283a4 "<speak><prosody rate=\"260%\">Break<break time=\"1000ms\"/>test</prosody></speak>" ) || \
( test_ssml_audio "<prosody 260%><break 1000ms>" 9849f0d27f5641db6da1a8aea82578e83656d323 "<speak><prosody rate=\"260%\">Break<break time=\"1000ms\"/>test</prosody></speak>" ) || \
( test_ssml_audio "<prosody 260%><break 1000ms>" 32a9c2887ec5b7d9d33d5503518ac0d384e43448 "<speak><prosody rate=\"260%\">Break<break time=\"1000ms\"/>test</prosody></speak>" ) || exit 1

# Ref: issue #1554
test_ssml_audio "buffer test #1" 966cd396530cf5558e7f6054d0ed7a9c8810cd0b "<speak><mark name=\"0:4\"/>read <mark name=\"5:10\"/>bytes <mark name=\"11:15\"/>from <mark name=\"16:21\"/>their <mark name=\"22:27\"/>input <mark name=\"28:31\"/>and <mark name=\"32:37\"/>write <mark name=\"38:41\"/>the <mark name=\"42:47\"/>bytes</speak>"
test_ssml_audio "buffer test #2" 2bd0699792e8511f5a447e66cbef8ef1a9cc762c "<speak><mark name=\"0:8\"/>15:29:30 <mark name=\"17:25\"/>Foxboron <mark name=\"26:27\"/>  <mark name=\"28:34\"/>jelle: <mark name=\"35:38\"/>the <mark name=\"39:44\"/>issue <mark name=\"45:49\"/>with <mark name=\"50:64\"/>  printsrcinfo <mark name=\"65:67\"/>in <mark name=\"68:75\"/>makepkg <mark name=\"76:78\"/>is <mark name=\"79:83\"/>that <mark name=\"84:91\"/>makepkg <mark name=\"92:99\"/>sources <mark name=\"100:103\"/>100 <mark name=\"104:109\"/>shell <mark name=\"110:117\"/>scripts </speak>"
test_ssml_audio "buffer test #3" 4896ce0c0a5e2e931c546849fc58b6289faae49b "<speak><mark name=\"0:8\"/>23:55:00 <mark name=\"16:21\"/>jelle <mark name=\"22:23\"/>  <mark name=\"24:30\"/>anyone <mark name=\"31:35\"/>ever <mark name=\"36:44\"/>consider <mark name=\"45:51\"/>adding <mark name=\"52:58\"/>pacman <mark name=\"59:61\"/> S <mark name=\"62:75\"/>  makedepends <mark name=\"76:78\"/>as <mark name=\"79:90\"/>makedepends <mark name=\"91:94\"/>are <mark name=\"95:97\"/>in <mark name=\"98:104\"/>syncdb <mark name=\"105:109\"/>this <mark name=\"110:115\"/>could <mark name=\"116:118\"/>be <mark name=\"119:123\"/>done <mark name=\"124:129\"/>quite <mark name=\"130:136\"/>easily </speak>"
